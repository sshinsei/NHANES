mean = forest_data$estimate,
lower = forest_data$lower,
upper = forest_data$upper,
zero = 1,
boxsize = 0.2,
lineheight = unit(7, "mm"),
cex = 0.9,
col = fpColors(box = "royalblue",
line = "darkblue",
summary = "royalblue"),
xlab = "OR (95% CI)",
title = "性别分层分析的森林图"
)
# 输出交互作用模型的结果
anova(mod_main,mod_inter)
new_dat$Age
levels(new_dat$Age)
table(new_dat$Age)
#### 年龄分层分析 ####
datN03 <- subset(new_dat, Age == ">40")
datN04 <- subset(new_dat, Age == "20-30")
datN04 <- subset(new_dat, Age == "31-40")
# 检查分组后各变量的水平数
check_levels <- function(data) {
factor_vars <- c("Race", "Marital", "EDUcation", "PIR", "Drink",
"Smoke", "hyptersion", "Stroke", "CHD", "lipids")
for(var in factor_vars) {
n_levels <- length(unique(data[[var]]))
if(n_levels < 2) {
cat(sprintf("警告：%s在该组中只有%d个水平\n", var, n_levels))
}
}
}
#### 年龄分层分析 ####
datN03 <- subset(new_dat, Age == ">40")
datN04 <- subset(new_dat, Age == "20-30")
datN05 <- subset(new_dat, Age == "31-40")
# 检查分组后各变量的水平数
check_levels <- function(data) {
factor_vars <- c("Race", "Marital", "EDUcation", "PIR", "Drink",
"Smoke", "hyptersion", "Stroke", "CHD", "lipids")
for(var in factor_vars) {
n_levels <- length(unique(data[[var]]))
if(n_levels < 2) {
cat(sprintf("警告：%s在该组中只有%d个水平\n", var, n_levels))
}
}
}
# 检查两个子组的变量水平
check_levels(datN03)
check_levels(datN04)
check_levels(datN05)
# 创建男性和女性的survey design对象
options(survey.lonely.psu = "adjust")  # 处理单个PSU的情况
design_male <- svydesign(data=datN03,
id=~SDMVPSU,
strata=~SDMVSTRA,
weights=~wt,
nest=TRUE)
design_female <- svydesign(data=datN05,
id=~SDMVPSU,
strata=~SDMVSTRA,
weights=~wt,
nest=TRUE)
# 男性亚组分析（使用try捕获可能的错误）
mod_male <- try({
svyglm(status ~ cally_log_q4 +
Age + Race + Marital + EDUcation + PIR +
Drink + BMI + Smoke + hyptersion + Stroke + CHD + lipids,
design = design_male,
family = quasibinomial)
})
# 检查两个子组的变量水平
check_levels(datN03)
# 男性亚组分析（使用try捕获可能的错误）
mod_male <- try({
svyglm(status ~ cally_log_q4 +
Gender + Race + Marital + EDUcation + PIR +
Drink + BMI + Smoke + hyptersion + Stroke + CHD + lipids,
design = design_male,
family = quasibinomial)
})
# 女性亚组分析（使用try捕获可能的错误）
mod_female <- try({
svyglm(status ~ cally_log_q4 +
Gender + Race + Marital + EDUcation + PIR +
Drink + BMI + Smoke + hyptersion + Stroke + CHD + lipids,
design = design_female,
family = quasibinomial)
})
# 输出结果（增加错误处理）
if(!inherits(mod_male, "try-error")) {
cat("\n男性亚组分析结果：\n")
print(summary(mod_male)$coefficients[2:5,])
} else {
cat("\n男性亚组分析出现错误，请检查变量水平\n")
}
if(!inherits(mod_female, "try-error")) {
cat("\n女性亚组分析结果：\n")
print(summary(mod_female)$coefficients[2:5,])
} else {
cat("\n女性亚组分析出现错误，请检查变量水平\n")
}
#### 交互作用分析 ####
# 不含交互项的主效应模型
mod_main <- svyglm(status ~ cally_log_q4 + Gender +
Age + Race + Marital + EDUcation + PIR +
Drink + BMI + Smoke + hyptersion + Stroke + CHD + lipids,
design = study_design,
family = quasibinomial)
# 含交互项的模型
mod_inter <- svyglm(status ~ cally_log_q4 * Gender +
Age + Race + Marital + EDUcation + PIR +
Drink + BMI + Smoke + hyptersion + Stroke + CHD + lipids,
design = study_design,
family = quasibinomial)
# 输出交互作用模型的结果
anova(mod_main,mod_inter) # P=0.2
#### 交互作用分析 ####
# 不含交互项的主效应模型
mod_main <- svyglm(status ~ cally_log_q4 + Gender +
Age + Race + Marital + EDUcation + PIR +
Drink + BMI + Smoke + hyptersion + Stroke + CHD + lipids,
design = study_design,
family = quasibinomial)
# 含交互项的模型
mod_inter <- svyglm(status ~ cally_log_q4 * Age +
Gender + Race + Marital + EDUcation + PIR +
Drink + BMI + Smoke + hyptersion + Stroke + CHD + lipids,
design = study_design,
family = quasibinomial)
# 输出交互作用模型的结果
anova(mod_main,mod_inter) # P=0.2
source("E:/LZ/25014/r.01.merge.R", echo=TRUE)
source("E:/LZ/25014/r.01.merge.R", echo=TRUE)
c("SEQN","RHQ074","RHD143","RHQ200","RHD280","RHQ305") %in% names(RHQ_D)
c("SEQN","RHQ074","RHD143","RHQ200","RHD280","RHQ305") %in% names(RHQ_E)
c("SEQN","RHQ074","RHD143","RHQ200","RHD280","RHQ305") %in% names(RHQ_F)
## -------------淋巴细胞 中性粒细胞 血小板-------------
files <- list.files(pattern=".*_CBC_.*", recursive=TRUE)
cat("找到", length(files), "个文件\n")
files
## -------------淋巴细胞 中性粒细胞 血小板 单核细胞-------------
files <- list.files(pattern=".*_CBC_.*", recursive=TRUE)
cat("找到", length(files), "个文件\n")
for(i in seq_along(files)){
file <- files[i]
cat(sprintf("正在处理第 %d/%d 个文件: %s\n", i, length(files), file))
# 提取DEMO_X形式的变量名
varname <- gsub(".*?(CBC_[A-Z]).*", "\\1", file)
assign(varname, read.xport(file.path(file)))
}
exam <- rbind(CBC_D[,c("SEQN","LBDNENO","LBDLYMNO","LBDMONO","LBXPLTSI")],
CBC_E[,c("SEQN","LBDNENO","LBDLYMNO","LBDMONO","LBXPLTSI")],
CBC_F[,c("SEQN","LBDNENO","LBDLYMNO","LBDMONO","LBXPLTSI")]
#CBC_G[,c("SEQN","LBDNENO","LBDLYMNO")],
#CBC_H[,c("SEQN","LBDNENO","LBDLYMNO")],
#CBC_I[,c("SEQN","LBDNENO","LBDLYMNO")],
#CBC_J[,c("SEQN","LBDNENO","LBDLYMNO")]
)
exam_dat <- rename(.data=exam,
Neutrophils=LBDNENO, #中性粒细胞
Lymphocyte=LBDLYMNO, #淋巴细胞
Monocytes=LBDMONO, #单核细胞
Platelets=LBXPLTSI #血小板计数 SI（1000 个细胞/微升）
)
source("E:/LZ/25014/r.01.merge.R", echo=TRUE)
nrow(data12)  # 6635
rm(list=ls())
setwd('E:/LZ')
if(! dir.exists("25014")) dir.create("25014")
setwd('./25014')
library(tidyverse)
####对数据进行整理####
# new_dat <- data09
new_dat <- read.csv("./00_rawdata/mergeData.csv", row.names = 1)
####__________年龄####
new_dat$Age <- ifelse(new_dat$Age<=30,1,
ifelse(new_dat$Age<=40,2,3))
#加标签
new_dat$Age <- factor(new_dat$Age,
levels = c(1,2,3),
labels = c("20-30","31-40",">40"))
table(new_dat$Age)
####__________性别####
table(new_dat$Gender)
#加标签
new_dat$Gender <- factor(new_dat$Gender,
levels = c(1,2),
labels = c("male","female"))
table(new_dat$Gender)
####__________种族####
table(new_dat$Race,useNA = "ifany")
# 1	Mexican American
# 2	Other Hispanic
# 3	Non-Hispanic White
# 4	Non-Hispanic Black
# 5	Other Race - Including Multi-Racial
new_dat$Race <- ifelse(new_dat$Race==1,1,
ifelse(new_dat$Race==3,2,
ifelse(new_dat$Race==4,3,4)))
new_dat$Race <- factor(new_dat$Race,
levels = c(1,2,3,4),
labels = c("Mexican American",
"Non-Hispanic White",
"Non-Hispanic Black",
"Other"))
table(new_dat$Race,useNA = "ifany")
####__________婚姻####
table(new_dat$Marital,useNA = "ifany")
# 1	Married
# 2	Widowed
# 3	Divorced
# 4	Separated
# 5	Never married
# 6	Living with partner
# 77	Refused
# 99	Don't Know
#文献的做法是已婚/未婚，根据样本量，Married	和Living with partner	进行的合并
new_dat$Marital <- ifelse(new_dat$Marital %in% c(1,6),1,2)
new_dat$Marital <- factor(new_dat$Marital,
levels = c(1,2),
labels = c("Yes","No"))
table(new_dat$Marital,useNA = "ifany")
####__________文化程度####
table(new_dat$EDUcation2,useNA = "ifany")
# 1	Less than 9th grade
# 2	9-11th grade (Includes 12th grade with no diploma)
# 3	High school graduate/GED or equivalent
# 4	Some college or AA degree
# 5	College graduate or above
# 7	Refused
# 9	Don't Know
# .	Missing
#文献的做法是将Less than 9th grade 和9-11th grade (Includes 12th grade with no diploma)合并
# 分类为：Below high school 和 High School or above
new_dat$EDUcation <- ifelse(new_dat$EDUcation2 %in% c(1,2),1,2)
new_dat$EDUcation <- factor(new_dat$EDUcation,c(1,2),
labels = c("Below high school",
"High School or above"))
table(new_dat$EDUcation,useNA = "ifany")
####__________PIR####
summary(new_dat$PIR) #可以发现，缺失了 442
new_dat$PIR <- ifelse(new_dat$PIR<1,1,2)
table(new_dat$PIR,useNA = "ifany") #很明显，文献将NA转在2组，也就是Not poor
new_dat$PIR <- ifelse(is.na(new_dat$PIR),2,new_dat$PIR)
new_dat$PIR <- factor(new_dat$PIR,levels = c(1,2),labels = c("Poor","Not poor"))
table(new_dat$PIR,useNA = "ifany") #再次分组
####__________BMI + 肥胖####
summary(new_dat$BMI)
new_dat$BMI <- cut(new_dat$BMI,
breaks = c(0, 25, 30, Inf),
labels = c("≤25", "25-30", ">30"),
right = TRUE, # 左开右闭
include.lowest = TRUE
)
table(new_dat$BMI,useNA = "ifany") #再次分组
####__________吸烟####
table(new_dat$Smoke_history,useNA = "ifany")  #有60个人有吸烟史，141人无吸烟史
# Smoke_history
# 1	Yes
# 2	No
# 7	Refused
# 9	Don't know
# .	Missing
table(new_dat$smoke_now,useNA = "ifany") # 29人
# smoke_now
# 1	Every day
# 2	Some days
# 3	Not at all
# 7	Refused
# 9	Don't know
# .	Missing
new_dat$Smoke <- ifelse(new_dat$smoke_now %in% c(1,2),1,
ifelse(is.na(new_dat$smoke_now),2,2))
new_dat$Smoke <- factor(new_dat$Smoke,
levels = c(1,2),
labels = c("Yes","No"))
table(new_dat$Smoke,useNA = "ifany")
#删除临时的无用变量
new_dat <- subset(new_dat, select=-c(Smoke_history,smoke_now))
#查看去除无用变量的数据结构
str(new_dat)
####__________饮酒####
table(new_dat$Drink,useNA = "ifany")
# 1	Yes
# 2	No
# 7	Refused
# 9	Don't know
# .	Missing
new_dat$Drink <- ifelse(new_dat$Drink == 1,1,2)
new_dat$Drink <- factor(new_dat$Drink,
levels = c(1,2),
labels = c("Yes","No"))
table(new_dat$Drink,useNA = "ifany")
####__________中风####
table(new_dat$Stroke,useNA = "ifany")
# 1 yes
# 2 no
# 7 refused
# 9 unkown
new_dat$Stroke <- ifelse(new_dat$Stroke==1,1,2)
new_dat$Stroke <- factor(new_dat$Stroke,levels = c(1,2),labels = c("Yes","No"))
table(new_dat$Stroke,useNA = "ifany")
####__________冠心病####
table(new_dat$CHD,useNA = "ifany")
# 1 yes
# 2 no
# 7 refused
# 9 unkown
new_dat$CHD <- ifelse(new_dat$CHD==1,1,2)
new_dat$CHD <- factor(new_dat$CHD,levels = c(1,2),labels = c("Yes","No"))
table(new_dat$CHD,useNA = "ifany")
####__________高血脂####
summary(new_dat$TC_mg)  #
summary(new_dat$TG_mg)  # 1
summary(new_dat$HDL_mg) #
summary(new_dat$LDL_mg) # 2441
table(new_dat$cholesterol,useNA = "ifany")
new_dat$TC_mg <- ifelse(is.na(new_dat$TC_mg),0,new_dat$TC_mg)
new_dat$HDL_mg <- ifelse(is.na(new_dat$HDL_mg),100,new_dat$HDL_mg) #低水平为正常
new_dat$LDL_mg <- ifelse(is.na(new_dat$LDL_mg),0,new_dat$LDL_mg)
new_dat$lipids <- ifelse(new_dat$TC_mg>200 |
new_dat$TG_mg>150 |
(new_dat$HDL_mg<40 & new_dat$Gender==1) |
(new_dat$HDL_mg<50 & new_dat$Gender==2) |
new_dat$LDL_mg>=130 |
new_dat$cholesterol==1,1,0)
table(new_dat$lipids,useNA = "ifany")
####__________SBP####
summary(new_dat$BPXSY1) # 288
summary(new_dat$BPXSY2) # 355
summary(new_dat$BPXSY3) # 394
summary(new_dat$BPXSY4) # 4336
#可以发现，4次的SBP都有缺失的存在，但是我们需要对4次的SBP求均值
#为了能够计算，先将缺失定义为0
new_dat$SBP1 <- ifelse(is.na(new_dat$BPXSY1),0,new_dat$BPXSY1)
new_dat$SBP2 <- ifelse(is.na(new_dat$BPXSY2),0,new_dat$BPXSY2)
new_dat$SBP3 <- ifelse(is.na(new_dat$BPXSY3),0,new_dat$BPXSY3)
new_dat$SBP4 <- ifelse(is.na(new_dat$BPXSY4),0,new_dat$BPXSY4)
#看看有多少个SBP来参与计算平均
new_dat$SBPn1 <- ifelse(is.na(new_dat$BPXSY1),0,1)
new_dat$SBPn2 <- ifelse(is.na(new_dat$BPXSY2),0,1)
new_dat$SBPn3 <- ifelse(is.na(new_dat$BPXSY3),0,1)
new_dat$SBPn4 <- ifelse(is.na(new_dat$BPXSY4),0,1)
new_dat$SBPn <- new_dat$SBPn1 + new_dat$SBPn2 + new_dat$SBPn3 + new_dat$SBPn4
#计算均值
new_dat$SBP <- (new_dat$SBP1 + new_dat$SBP2 + new_dat$SBP3 + new_dat$SBP4)/new_dat$SBPn
summary(new_dat$SBP) #发现有  74 人的4次SBP均缺失，暂时不处理
sbp_temp <- subset(new_dat,is.na(new_dat$BPXSY1) &
is.na(new_dat$BPXSY2) &
is.na(new_dat$BPXSY3) &
is.na(new_dat$BPXSY4))
nrow(sbp_temp) #验证得到，确实有 74 个人的四次血压均为缺失
#删除临时的无用变量
new_dat <- subset(new_dat, select=-c(SBP1,SBP2,SBP3,SBP4,
BPXSY1,BPXSY2,BPXSY3,BPXSY4,
SBPn1,SBPn2,SBPn3,SBPn4,SBPn
))
str(new_dat)
####__________DBP ####
summary(new_dat$BPXDI1)
summary(new_dat$BPXDI2)
summary(new_dat$BPXDI3)
summary(new_dat$BPXDI4)
#可以发现，4次的DBP都有缺失的存在，但是我们需要对4次的DBP求均值
#为了能够计算，先将缺失定义为0
new_dat$DBP1 <- ifelse(is.na(new_dat$BPXDI1),0,new_dat$BPXDI1)
new_dat$DBP2 <- ifelse(is.na(new_dat$BPXDI2),0,new_dat$BPXDI2)
new_dat$DBP3 <- ifelse(is.na(new_dat$BPXDI3),0,new_dat$BPXDI3)
new_dat$DBP4 <- ifelse(is.na(new_dat$BPXDI4),0,new_dat$BPXDI4)
#看看有多少个SBP来参与计算平均
new_dat$DBPn1 <- ifelse(is.na(new_dat$BPXDI1),0,1)
new_dat$DBPn2 <- ifelse(is.na(new_dat$BPXDI2),0,1)
new_dat$DBPn3 <- ifelse(is.na(new_dat$BPXDI3),0,1)
new_dat$DBPn4 <- ifelse(is.na(new_dat$BPXDI4),0,1)
new_dat$DBPn <- new_dat$DBPn1 + new_dat$DBPn2 + new_dat$DBPn3 + new_dat$DBPn4
#计算均值
new_dat$DBP <- (new_dat$DBP1 + new_dat$DBP2 + new_dat$DBP3 + new_dat$DBP4)/new_dat$DBPn
summary(new_dat$DBP) #发现有3个人的4次DBP均缺失，暂时不处理
dbp_temp <- subset(new_dat,is.na(new_dat$BPXDI1) &
is.na(new_dat$BPXDI2) &
is.na(new_dat$BPXDI3) &
is.na(new_dat$BPXDI4))
nrow(dbp_temp) #验证得到，确实有3个人的四次血压均为缺失
#删除临时的无用变量
new_dat <- subset(new_dat,
select=-c(DBP1,DBP2,DBP3,DBP4,
BPXDI1,BPXDI2,BPXDI3,BPXDI4,
DBPn1,DBPn2,DBPn3,DBPn4,DBPn
))
####__________高血压####
table(new_dat$hypter,useNA = "ifany")
#需要综合：
#  高血压
#  SBP>=130 40130253
#  DBP>=80 40130253
summary(new_dat$SBP) #查看变量的分布
new_dat$SBP_new <- ifelse(is.na(new_dat$SBP),0,new_dat$SBP) #将缺失赋值为0
summary(new_dat$DBP) #查看变量的分布
new_dat$DBP_new <- ifelse(is.na(new_dat$DBP),0,new_dat$DBP) #将缺失赋值为0
new_dat$hyptersion <- ifelse(new_dat$hypter==1|new_dat$SBP_new>=130|new_dat$DBP_new>=80,1,2)
new_dat$hyptersion <- factor(new_dat$hyptersion,levels = c(1,2),labels = c("Yes","No"))
table(new_dat$hyptersion,useNA = "ifany")
new_dat <- subset(new_dat, select=-c(hypter,SBP_new,DBP_new))
#查看去除无用变量的数据结构
str(new_dat)
new_dat$AISI <- (new_dat$Neutrophils*new_dat$Monocytes*new_dat$Platelets)/new_dat$Lymphocyte
# 取log
new_dat$AISI_log <- log(new_dat$AISI)
# 因变量----------------
table(new_dat$MI,useNA = "ifany")
new_dat$MI <- ifelse(new_dat$MI==1,1,0)
new_dat$MI <- factor(new_dat$MI,levels = c(1,0))
table(new_dat$MI,useNA = "ifany")
# 去除多于变量
new_dat <- subset(new_dat, select=-c(WC,EDUcation3,Neutrophils,Lymphocyte,
albumin, CRP_mg_l, EDUcation2
))
####转换权重####
new_dat$wt_LDL <- ifelse(new_dat$wt_LDL==0 | is.na(new_dat$wt_LDL),new_dat$WTMEC2YR,new_dat$wt_LDL)
# new_dat$wt_glu <- ifelse(new_dat$wt_glu==0 | is.na(new_dat$wt_glu),new_dat$WTMEC2YR,new_dat$wt_glu)
new_dat$wt <- apply(new_dat[,c("wt_LDL","WTMEC2YR"),],1,min) #取出最小值
new_dat$wt <- new_dat$WTMEC2YR/3 # 3个周期
write.csv(new_dat, "cleanData.csv")
rm(list=ls())
setwd('E:/LZ')
if(! dir.exists("25014")) dir.create("25014")
setwd('./25014')
library(survey)
new_dat <- read.csv("cleanData.csv",row.names = 1)
####研究设计####
options(survey.lonely.psu = "adjust")
study_design <- svydesign(data=new_dat,
id=~SDMVPSU,
strata=~SDMVSTRA,
weights=~wt, nest=TRUE)
#均数和标准误
svymean(~Age,study_design)
#频数+构成比
freq <- table(new_dat$Age)
prop <- svytable(~Age,study_design)
per <- rbind(prop[1]/sum(prop),prop[2]/sum(prop),prop[2]/sum(prop))
paste0(freq," (",sprintf("%0.2f",per),")")
options(survey.lonely.psu = "adjust")
study_design <- svydesign(data=new_dat,
id=~SDMVPSU,
strata=~SDMVSTRA,
weights=~wt, nest=TRUE)
####单因素线性回归####
mod <- svyglm(MI~AISI_log, study_design)
summary(mod)
####单因素线性回归####
mod <- svyglm(MI~AISI_log, study_design)
summary(mod)
####单因素logistic回归####
mod <- svyglm(MI~AISI_log, study_design, family="quasibinomial")
summary(mod)
####单因素logistic回归####
mod <- svyglm(MI~AISI, study_design, family="quasibinomial")
summary(mod)
####单因素logistic回归####
mod <- svyglm(MI~AISI, study_design, family="quasibinomial")
summary(mod)
####多因素logstic回归####
mod_mult <- svyglm(MI~AISI+Age + Race + EDUcation +
PIR, study_design, family="quasibinomial")
summary(mod_mult)
#四分位数分组
AISI_m <- svyquantile(~AISI,study_design,c(0.25,0.5,0.75))
AISI_m
AISI_q <- quantile(new_dat$AISI, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
new_dat$AISI_q4 <- cut(new_dat$AISI,
breaks = c(-Inf, AISI_q[1], AISI_q[2], AISI_q[3], Inf),
labels = c("Q1","Q2","Q3","Q4"),
right = TRUE,
include.lowest = TRUE)
new_dat$AISI_q4 <- factor(new_dat$AISI_q4,
levels = c("Q1","Q2","Q3","Q4"))
table(new_dat$AISI_q4)
#转化参照
new_dat$AISI_q4 <-relevel(new_dat$AISI_q4,"Q4")
table(new_dat$MI)
#转化结局的编码
new_dat$status <- new_dat$MI
study_design <- svydesign(data=new_dat,
id=~SDMVPSU,
strata=~SDMVSTRA,
weights=~wt, nest=TRUE)
####进行回归####
BMI_mod1 <- svyglm(status~AISI_q4, study_design,family = quasibinomial)
summary(BMI_mod1)
BMI_mod2 <- svyglm(status~AISI_q4+Age+Race+Marital+
EDUcation+PIR+Gender,
study_design,family = quasibinomial)
summary(BMI_mod2)
BMI_mod3 <- svyglm(status~AISI_q4+
Age+Race+Marital+ EDUcation+PIR+Gender+
Drink+BMI+Smoke+hyptersion+Stroke+CHD+lipids,
study_design,family = quasibinomial)
summary(BMI_mod3)
source("E:/LZ/25014/r.01.merge.R", echo=TRUE)
# 5. 进行纳排--------------
data00 <- merged_dat # 16539
str(data00)
### (1) 人口统计学不符合条件-----------
####__________年龄####
data01 <- subset(data00,data00$Age>=18) # 16539
####__________怀孕女性####
table(data01$Pregnancy,useNA = "ifany")  #缺失的数据体现出来
# data04 <- subset(data03,data03$Pregnancy!=1) #此语句会把缺失也排除
data02 <- subset(data01,data01$Pregnancy %in% c(2,9,NA)) #排除了正在怀孕的女性
